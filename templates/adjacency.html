<!DOCTYPE html>
<html class="ocks-org do-not-copy">
<meta charset="utf-8">
<style>
  .background {
    fill: #eee;
  }

  line {
    stroke: #fff;
  }

  text.active {
    fill: red;
  }
</style>

<body>


  <script src="//d3js.org/d3.v2.min.js" charset="utf-8"></script>
  <script>
    var margin = {
        top: 80,
        right: 0,
        bottom: 10,
        left: 80
      },
      width = 720,
      height = 720;

    var x = d3.scale.ordinal().rangeBands([0, width]),
      z = d3.scale.linear().domain([0, 4]).clamp(true),
      c = d3.scale.category10().range([
        d3.rgb(0, 169, 224),
        d3.rgb(206, 0, 88),
        d3.rgb(106, 209, 227),
        d3.rgb(229, 106, 84),
        d3.rgb(167, 230, 215),
        d3.rgb(236, 134, 208),
        d3.rgb(255, 181, 73),
        d3.rgb(255, 160, 106),
        d3.rgb(130, 70, 175),
        d3.rgb(210, 159, 19),
        d3.rgb(201, 100, 207),
        d3.rgb(254, 209, 65),
      ]);

    var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .style("margin-left", -margin.left + "px")
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.json("../data/miserables.json", function(miserables) {

      var matrix = [],
        nodes = miserables.nodes,
        n = nodes.length;

      // Compute index per node.
      nodes.forEach(function(node, i) {
        node.index = i;
        node.count = 0;
        matrix[i] = d3.range(n).map(function(j) {
          return {
            x: j,
            y: i,
            z: 0
          };
        });
      });

      // Convert links to matrix; count character occurrences.
      miserables.links.forEach(function(link) {
        matrix[link.source][link.target].z += link.value;
        matrix[link.target][link.source].z += link.value;
        matrix[link.source][link.source].z += link.value;
        matrix[link.target][link.target].z += link.value;
        nodes[link.source].count += link.value;
        nodes[link.target].count += link.value;
      });

      // Precompute the orders.
      var orders = {
        name: d3.range(n).sort(function(a, b) {
          return d3.ascending(nodes[a].name, nodes[b].name);
        }),
        count: d3.range(n).sort(function(a, b) {
          return nodes[b].count - nodes[a].count;
        }),
        group: d3.range(n).sort(function(a, b) {
          return nodes[b].group - nodes[a].group;
        })
      };

      // The default sort order.
      x.domain(orders.group);

      svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height);

      var row = svg.selectAll(".row")
        .data(matrix)
        .enter().append("g")
        .attr("class", "row")
        .attr("transform", function(d, i) {
          return "translate(0," + x(i) + ")";
        })
        .each(row);

      row.append("line")
        .attr("x2", width);

      row.append("text")
        .attr("x", -6)
        .attr("y", x.rangeBand() / 2)
        .attr("dy", ".32em")
        .attr("text-anchor", "end")
        .text(function(d, i) {
          return nodes[i].name;
        });

      var column = svg.selectAll(".column")
        .data(matrix)
        .enter().append("g")
        .attr("class", "column")
        .attr("transform", function(d, i) {
          return "translate(" + x(i) + ")rotate(-90)";
        });

      column.append("line")
        .attr("x1", -width);

      column.append("text")
        .attr("x", 6)
        .attr("y", x.rangeBand() / 2)
        .attr("dy", ".32em")
        .attr("text-anchor", "start")
        .text(function(d, i) {
          return nodes[i].name;
        });

      function row(row) {
        var cell = d3.select(this).selectAll(".cell")
          .data(row.filter(function(d) {
            return d.z;
          }))
          .enter().append("rect")
          .attr("class", "cell")
          .attr("x", function(d) {
            return x(d.x);
          })
          .attr("width", x.rangeBand())
          .attr("height", x.rangeBand())
          .style("fill-opacity", function(d) {
            return z(d.z);
          })
          .style("fill", function(d) {
            return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null;
          })
          .on("mouseover", mouseover)
          .on("mouseout", mouseout);
      }

      function mouseover(p) {
        d3.selectAll(".row text").classed("active", function(d, i) {
          return i == p.y;
        });
        d3.selectAll(".column text").classed("active", function(d, i) {
          return i == p.x;
        });
      }

      function mouseout() {
        d3.selectAll("text").classed("active", false);
      }

    });
  </script>
</body>
